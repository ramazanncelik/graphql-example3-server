"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useParserAndValidationCache = void 0;
const utils_1 = require("@graphql-tools/utils");
const create_lru_cache_js_1 = require("../utils/create-lru-cache.js");
function useParserAndValidationCache({ documentCache = (0, create_lru_cache_js_1.createLRUCache)(), errorCache = (0, create_lru_cache_js_1.createLRUCache)(), validationCache = true, }) {
    const memoizedValidateByRules = typeof validationCache === 'boolean'
        ? (0, create_lru_cache_js_1.createLRUCache)()
        : validationCache;
    return {
        onParse({ parseFn, setParseFn, }) {
            setParseFn(function memoizedParse(source) {
                const strDocument = typeof source === 'string' ? source : source.body;
                let document = documentCache.get(strDocument);
                if (!document) {
                    const parserError = errorCache.get(strDocument);
                    if (parserError) {
                        throw parserError;
                    }
                    try {
                        document = parseFn(source);
                    }
                    catch (e) {
                        errorCache.set(strDocument, e);
                        throw e;
                    }
                    documentCache.set(strDocument, document);
                }
                return document;
            });
        },
        onValidate({ validateFn, setValidationFn, }) {
            if (validationCache !== false) {
                setValidationFn(function memoizedValidateFn(schema, document, rules) {
                    const rulesKey = rules?.map((rule) => rule.name).join(',') || '';
                    let memoizedValidateFnForRules = memoizedValidateByRules.get(rulesKey);
                    if (!memoizedValidateFnForRules) {
                        memoizedValidateFnForRules = (0, utils_1.memoize2of4)(validateFn);
                        memoizedValidateByRules.set(rulesKey, memoizedValidateFnForRules);
                    }
                    return memoizedValidateFnForRules(schema, document, rules);
                });
            }
        },
    };
}
exports.useParserAndValidationCache = useParserAndValidationCache;
